<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdn.webix.com/edge/webix.css" type="text/css">
    <link rel="stylesheet" href="button.css" type="text/css">
    <script src="https://cdn.webix.com/edge/webix.js" type="text/javascript"></script>
</head>
<body>
<!--<a href="#" class="button button-circle">Silver Circle</a>-->
<!--<a href="#" class="button button-circle button-primary">Blue Circle</a>-->
<!--<a href="#" class="button button-circle button-action">Green Circle</a>-->
<!--<a href="#" class="button button-circle button-highlight">Orange Circle</a>-->
<!--<a href="#" class="button button-circle button-caution">Red Circle</a>-->
<!--<a href="#" class="button button-circle button-royal">Purple Circle</a>-->

<div id="container"></div>

<script>

    function buttonCheck(obj, column) {
        var Stage = obj.stages.find(function (item) {
            return item.name === column
        });
        if (Stage && Stage.status === "Completed") {
            return "<a href=\"#\" class=\"button button-circle button-action\">";
        }
        if (Stage && Stage.status === "Error") {
            return "<a href=\"#\" class=\"button button-circle button-caution\">";
        }
        if (Stage && Stage.status === "In process") {
            return "<a href=\"#\" class=\"button button-circle\">";
        }
    }

    function standartLog(stage) {
        switch (stage.status) {
            case "Completed":
                $$("log").setValue(stage.log);
                break;
            case "Error":
                $$("log").setValue(stage.log + "\n" + "\n" + "\n" + "Errors:\n" + stage.errors);
                break;
            case "In Process":
                $$("log").setValue(stage.log);
        }
        $$("Current Advances").hide();
    }

    var form1 = [
        {type: "header", template: "OCR Helper"},
        {
            margin: 5, cols: [
                {
                    rows: [
                        {
                            view: "datatable",
                            scroll: false,
                            id: "dtable",
                            resizeColumn: true,
                            css: "my-dtable",
                            on: {
                                'onItemClick': function (id, e, node) {
                                    var item = this.getItem(id);


                                    var stage = item.stages.find(function (element) {
                                        return element.name === id.column
                                    });
                                    switch (id.column) {
                                        case "opportunityName":
                                            showContextMenu(node)

                                            break;
                                        case "Downloaded":
                                            standartLog(stage);
                                            break;
                                        case "Files attached":
                                            standartLog(stage);
                                            break;
                                        case "Integrity validated":
                                            standartLog(stage);
                                            if (stage.status === "Error") {
                                                webix.message("Please, open Capture and fix some problems")
                                            }
                                            break;
                                        case "Current advances checked":
                                            standartLog(stage);
                                            if (stage.status === "Error") {
                                                $$("Current Advances").show();
                                            }
                                            break;
                                        case "CBC pulled":
                                            standartLog(stage);
                                            break;
                                        case "Completed":
                                            standartLog(stage);
                                            if (stage.status === "Error") {
                                                webix.message("Please, try to export the statement again");
                                            }
                                            break;
                                    }
                                }
                            },
                            columns: [
                                {id: "id", header: "id", width: 30},
                                {
                                    id: "opportunityName", header: "Opportunity Name", fillspace: true},
                                {
                                    id: "Downloaded",
                                    header: "Downloaded",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "Files attached",
                                    header: "Attached",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "Integrity validated",
                                    header: "Validated",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "Current advances checked",
                                    header: "Advances",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "CBC pulled",
                                    header: "CBC",
                                    adjust: "header",
                                    css: {'text-align': 'center'},
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "Submission validated",
                                    header: "Submission",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "Completed",
                                    header: "Completed",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                }
                            ]
                        },
                        {
                            id: "Current Advances",
                            view: "toolbar",
                            hidden: true,
                            height: 150,
                            elements: [
                                {
                                    id: "ErrorAdvancesList",
                                    view: "list",
                                    on: {
                                        "onItemClick": function (id) {
                                            var obj = this.getItem(id);
                                            var stage = obj.stages.find(function (item) {
                                                return item.name === "Current advances checked"
                                            });
                                            $$("AdvanceEditor").setValue(stage.errors);
                                        }
                                    },
                                    template: function (obj) {
                                        var stage = obj.stages.find(function (item) {
                                            return item.name === "Current advances checked"
                                        });
                                        return stage.errors
                                    }
                                },
                                {
                                    rows: [
                                        {
                                            cols: [
                                                {
                                                    id: "AdvanceEditor",
                                                    view: "textarea",
                                                    placeholder: "Write down new MCI"
                                                },
                                                {
                                                    id: "dropDown",
                                                    view: "select",
                                                    options: [
                                                        "Placeholder #1",
                                                        "Placeholder #2",
                                                        "Placeholder #3"
                                                    ],
                                                    width: 120
                                                }
                                            ]
                                        },
                                        {
                                            id: "MCI button",
                                            view: "button",
                                            value: "Assign",
                                            on: {
                                                "onItemClick": function () {
                                                    webix.message("I don't know how to assign new MCI's")
                                                }
                                            }
                                        },
                                        {
                                            id: "Hide button",
                                            view: "button",
                                            value: "Done",
                                            on: {
                                                "onItemClick": function () {
                                                    $$("Current Advances").hide();
                                                }
                                            }
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {view: "resizer"},
                {
                    id: "log",
                    view: "textarea",
                    css: "logSpace",
                    type: "form",
                    value: "Here is log",
                    width: 350,
                    height: 500
                }
            ],
        },
        {
            view: "button", name: "submit", value: "Export Opportunity",
            on: {
                "onItemClick": function () {
                    webix.message("How do we export, again?")
                }
            }
        }
    ];
    webix.ui({
        view: "form",
        margin: 0,
        id: "my_form",
        css: "form",
        elements: form1
    });
    webix.ajax().get('data.json', function (t, d) {
        $$('dtable').parse(d.json().opportunities);
        $$('ErrorAdvancesList').parse(d.json().opportunities)
    })


    function showContextMenu (node) {
        webix.ui({
            view:"contextmenu",
            id:"menu",
            width:200,
            data:[
                "Export", "Delete", "Export to SF"
            ]
        });

        $$("menu").show(node, {pos:"right"});



        $$("dtable").$view.oncontextmenu = function(){return false};
    }






</script>
</body>
</html>