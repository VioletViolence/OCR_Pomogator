<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdn.webix.com/edge/webix.css" type="text/css">
    <link rel="stylesheet" href="button.css" type="text/css">
    <script src="https://cdn.webix.com/edge/webix.js" type="text/javascript"></script>
</head>
<body>

<div id="container"></div>

<script>

    var form1 = [
        {type: "header", template: function (){
              return  "<div class='header-container'><div>OCR Helper</div><div> <input type='button' onclick='return showLog(this)' value='Show Log' class='logButton'' /></div></div>"
            }},
        {
            margin: 5, cols: [
                {
                    rows: [
                        {
                            view: "datatable",
                            scroll: false,
                            id: "dtable",
                            resizeColumn: true,
                            css: "my-dtable",
                            on: {
                                'onItemClick': function (id, e, node) {
                                    var item = this.getItem(id);


                                    var stage = item.stages.find(function (element) {
                                        return element.name === id.column
                                    });
                                    switch (id.column) {
                                        case "name":
                                            showContextMenu(node)

                                            break;
                                        case "DocumentsDownloaded":
                                            standartLog(stage.stageStatus);
                                            break;
                                        case "Files attached":
                                            standartLog(stage.stageStatus);
                                            break;
                                        case "Integrity validated":
                                            standartLog(stage.stageStatus);
                                            if (stage.stageStatus.statusStr === "Error") {
                                                webix.message("Please, open Capture and fix some problems")
                                            }
                                            break;
                                        case "Current advances checked":
                                            standartLog(stage.stageStatus);
                                            if (stage.stageStatus.statusStr === "Error") {
                                                $$("Current Advances").show();
                                            }
                                            break;
                                        case "CBC pulled":
                                            standartLog(stage.stageStatus);
                                            break;
                                        case "Completed":
                                            standartLog(stage.stageStatus);
                                            if (stage.stageStatus.statusStr === "Error") {
                                                webix.message("Please, try to export the statement again");
                                            }
                                            break;
                                    }
                                }
                            },
                            columns: [
                                {id: "id", header: "id", width: 30},
                                {id: "name", header: "Opportunity Name", fillspace: true},

                                {
                                    id: "DocumentsDownloaded",
                                    header: "Downloaded",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "Files attached",
                                    header: "Attached",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "Integrity validated",
                                    header: "Validated",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "Current advances checked",
                                    header: "Advances",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "CBC pulled",
                                    header: "CBC",
                                    adjust: "header",
                                    css: {'text-align': 'center'},
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "Submission validated",
                                    header: "Submission",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "Completed",
                                    header: "Completed",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                }
                            ]
                        },
                        {
                            id: "Current Advances",
                            view: "toolbar",
                            hidden: true,
                            height: 250,
                            elements: [
                                {
                                    id: "ErrorAdvancesList",
                                    view: "list",
                                    on: {
                                        "onItemClick": function (id) {
                                            var obj = this.getItem(id);
                                            var stage = obj.stages.find(function (item) {
                                                return item.name === "Current advances checked"
                                            });
                                            $$("AdvanceEditor").setValue(stage.errors);
                                        }
                                    },
                                    template: function (obj) {
                                        var stage = obj.stages.find(function (item) {
                                            return item.name === "Current advances checked"
                                        });
                                        return stage.errors
                                    }
                                },
                                {
                                    rows: [
                                        {
                                            cols: [
                                                {
                                                    id: "AdvanceEditor",
                                                    view: "textarea",
                                                    placeholder: "Write down new MCI"
                                                },
                                                {
                                                    id: "dropDown",
                                                    view: "select",
                                                    options: [
                                                        "Placeholder #1",
                                                        "Placeholder #2",
                                                        "Placeholder #3"
                                                    ],
                                                    width: 120
                                                }
                                            ]
                                        },
                                        {
                                            id: "MCI button",
                                            view: "button",
                                            value: "Assign",
                                            on: {
                                                "onItemClick": function () {
                                                    webix.message("I don't know how to assign new MCI's")
                                                }
                                            }
                                        },
                                        {
                                            id: "Hide button",
                                            view: "button",
                                            value: "Done",
                                            on: {
                                                "onItemClick": function () {
                                                    $$("Current Advances").hide();
                                                }
                                            }
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {view: "resizer"},
                {
                    id: "log",
                    view: "textarea",
                    hidden: true,
                    css: "logSpace",
                    value: "Here is log",
                    width: 400

                }
            ],
        }
        // {
        //     view: "button", name: "submit", value: "Reload",
        //     on: {
        //         "onItemClick": function () {
        //
        //         }
        //     }
        // }
    ];

    function showLog(element) {
        if (!$$("log").isVisible() && element.value == "Show Log") {
            element.value = "Hide Log";
            $$("log").show();
        } else {
            element.value = "Show Log";
            $$("log").hide();
        }

    }


    webix.ui({
        view: "form",
        margin: 0,
        id: "my_form",
        css: "form",
        elements: form1
    });
    webix.ajax().get('http://localhost:8080/status', function (t, d) {
      //  console.log(d.json());
        $$('dtable').parse(d.json().oppos);
        $$('ErrorAdvancesList').parse(d.json().oppos)
    })


    function showContextMenu (node) {
        webix.ui({
            view:"contextmenu",
            id:"menu",
            width:200,
            data:[
                "Reload", "Delete", "Export to SF"
            ]
        });

        $$("menu").show(node, {pos:"right"});



        $$("dtable").$view.oncontextmenu = function(){return false};
    }

    function buttonCheck(obj, column) {
        var stage = obj.stages.find(function (item) {
            return item.name === column
        });
        // console.log(column, stage && stage.stageStatus, obj.stages)
        stage = stage && stage.stageStatus;
        if (stage && stage.statusStr === "CompletedStStatus") {
            return "<a href=\"#\" class=\"button button-circle button-action\">";
        }
        if (stage && stage.statusStr === "ErrorStStatus") {
            return "<a href=\"#\" class=\"button button-circle button-caution\">";
        }
        if (stage && stage.statusStr === "InProcessStStatus") {
            return "<a href=\"#\" class=\"button button-circle\">";
        }
        return ''
    }

    function standartLog(stage) {
        switch (stage.statusStr) {
            case "CompletedStStatus":
                $$("log").setValue(stage.log);
                break;
            case "Error":
                $$("log").setValue(stage.log + "\n" + "\n" + "\n" + "Errors:\n" + stage.errors);
                break;
            case "In Process":
                $$("log").setValue(stage.log);
        }
        $$("Current Advances").hide();
    }




</script>
</body>
</html>