<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdn.webix.com/edge/webix.css" type="text/css">
    <link rel="stylesheet" href="button.css" type="text/css">
    <script src="https://cdn.webix.com/edge/webix.js" type="text/javascript"></script>
    <script src="a.js" type="text/javascript"></script>
    <script src="b.js" type="text/javascript"></script>
</head>
<body>

<div id="container"></div>

<script>

    var blockNumber = 0;

    var form1 = [
        {
            type: "header", template: function () {
                return "<div class='header-container'><div>OCR Helper</div><div> <input type='button' id='logButton' onclick='showHideLog()' value='Show Log' class='logButton'' /></div></div>"
            }
        },
        {
            margin: 5, cols: [
                {
                    rows: [
                        {
                            view: "datatable",
                            scrollY: true,
                            id: "dtable",
                            resizeColumn: true,
                            css: "my-dtable",
                            on: {
                                'onItemClick': function (id, e, node) {
                                    var item = this.getItem(id);
                                    webix.message(id.column)
                                    var stage = item.stages.find(function (element) {
                                        return element.name === id.column
                                    });
                                    switch (id.column) {
                                        case "name":
                                            showContextMenu(node)

                                            break;
                                        case "DocumentsDownloaded":
                                            standartLog(stage.stageStatus);
                                            showLog()
                                            break;
                                        case "FilesAttached":
                                            standartLog(stage.stageStatus);
                                            break;
                                        case "Integrity validated":
                                            standartLog(stage.stageStatus);
                                            if (stage.stageStatus.statusStr === "Error") {
                                                webix.message("Please, open Capture and fix some problems")
                                            }
                                            break;
                                        case "AdvancesChecked":
                                            standartLog(stage.stageStatus);
                                            showAdvancesPopup()
                                         //   $$("advances").show();
                                            // if (stage.stageStatus.statusStr === "Error") {
                                            //     $$("Current Advances").show();
                                            // }
                                            break;
                                        case "CBC pulled":
                                            standartLog(stage.stageStatus);
                                            break;
                                        case "Completed":
                                            standartLog(stage.stageStatus);
                                            if (stage.stageStatus.statusStr === "Error") {
                                                webix.message("Please, try to export the statement again");
                                            }
                                            break;
                                    }
                                }
                            },
                            columns: [
                                {id: "id", header: "id", width: 30},
                                {id: "name", header: "Opportunity Name", fillspace: true},

                                {
                                    id: "DocumentsDownloaded",
                                    header: "Downloaded",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "FilesAttached",
                                    header: "Attached",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "Integrity validated",
                                    header: "Validated",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "AdvancesChecked",
                                    header: "Advances",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "CBC pulled",
                                    header: "CBC",
                                    adjust: "header",
                                    css: {'text-align': 'center'},
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "Submission validated",
                                    header: "Submission",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                },
                                {
                                    id: "Completed",
                                    header: "Completed",
                                    css: {'text-align': 'center'},
                                    adjust: "header",
                                    template: function (obj) {
                                        return buttonCheck(obj, this.id)
                                    }
                                }
                            ]
                        },
                        {view: "resizer"},
                        {
                            id: "advances",
                            view: "toolbar",
                            hidden: true,
                            height: 250,
                            elements: [
                                {
                                    view: "datatable",
                                    scroll: true,
                                    id: "advTable",
                                    resizeColumn: true,
                                    columns: [
                                        {id: "date", header: "Date"},
                                        {id: "descr", header: "Description", fillspace: true},
                                        {id: "amount", header: "Amount"},
                                        {id: "tags", header: "Tags", width: 180}
                                    ],
                                    on: {
                                        'onItemClick': function (id, e, node) {

                                             var obj = this.getItem(id);

                                            $$("AdvanceEditor").setValue(obj.descr)
                                        }}
                                },
                                {
                                    width: 400,
                                    rows: [
                                        {
                                            cols: [
                                                {
                                                    id: "next-block",
                                                    view: "button",
                                                    value: "Next Block",
                                                    on: {
                                                        "onItemClick": function () {
                                                            getAdvancesData(blockNumber + 1)
                                                            blockNumber += 1
                                                        }
                                                    }
                                                },
                                                {
                                                    id: "ignore-block",
                                                    view: "button",
                                                    value: "Ignore Block",
                                                    on: {
                                                        "onItemClick": function () {
                                                        }
                                                    }
                                                }
                                            ]
                                        },
                                        {
                                            cols: [
                                                {
                                                    id: "prev-block",
                                                    view: "button",
                                                    value: "Previous Block",
                                                    on: {
                                                        "onItemClick": function () {
                                                            getAdvancesData(blockNumber - 1)
                                                            blockNumber -= 1
                                                        }
                                                    }
                                                },
                                                {
                                                    id: "remove-block",
                                                    view: "button",
                                                    value: "Remove Block",
                                                    on: {
                                                        "onItemClick": function () {
                                                            removeBlock(blockNumber)
                                                        }
                                                    }
                                                }
                                            ]
                                        },
                                        {
                                            id: "AdvanceEditor",
                                            view: "textarea",
                                            placeholder: "Write down new MCI"
                                        },
                                                        {
                                                            id: "dropDown",
                                                            view: "select",
                                                            options: [
                                                                "Placeholder #1",
                                                                "Placeholder #2",
                                                                "Placeholder #1",
                                                                "Placeholder #2",
                                                                "Placeholder #1",
                                                                "Placeholder #2",
                                                                "Placeholder #1",
                                                                "Placeholder #2",
                                                                "Placeholder #1",
                                                                "Placeholder #2",
                                                                "Placeholder #3"
                                                            ]
                                                        },
                                        {
                                            id: "fixed-block",
                                            view: "button",
                                            value: "Mark As Fixed Block",
                                            on: {
                                                "onItemClick": function () {
                                                }
                                            }
                                        }
                                    ]
                                }
                                // {
                                //     id: "ErrorAdvancesList",
                                //     view: "list",
                                //     on: {
                                //         "onItemClick": function (id) {
                                //             var obj = this.getItem(id);
                                //             var stage = obj.stages.find(function (item) {
                                //                 return item.name === "Current advances checked"
                                //             });
                                //             $$("AdvanceEditor").setValue(stage.errors);
                                //         }
                                //     },
                                //     template: function (obj) {
                                //         var stage = obj.stages.find(function (item) {
                                //             return item.name === "Current advances checked"
                                //         });
                                //         return stage.errors
                                //     }
                                // },
                                // {
                                //     rows: [
                                //         {
                                //             cols: [
                                //                 {
                                //                     id: "AdvanceEditor",
                                //                     view: "textarea",
                                //                     placeholder: "Write down new MCI"
                                //                 },
                                //                 {
                                //                     id: "dropDown",
                                //                     view: "select",
                                //                     options: [
                                //                         "Placeholder #1",
                                //                         "Placeholder #2",
                                //                         "Placeholder #3"
                                //                     ],
                                //                     width: 120
                                //                 }
                                //             ]
                                //         },
                                //         {
                                //             id: "MCI button",
                                //             view: "button",
                                //             value: "Assign",
                                //             on: {
                                //                 "onItemClick": function () {
                                //                     webix.message("I don't know how to assign new MCI's")
                                //                 }
                                //             }
                                //         },
                                //         {
                                //             id: "Hide button",
                                //             view: "button",
                                //             value: "Done",
                                //             on: {
                                //                 "onItemClick": function () {
                                //                     $$("Current Advances").hide();
                                //                 }
                                //             }
                                //         }
                                //     ]
                                // }
                            ]
                        }
                    ]
                },
                {view: "resizer"},
                {
                    id: "log",
                    view: "textarea",
                    hidden: true,
                    css: "logSpace",
                    value: "Here is log",
                    width: 300

                }
            ],
        }
        // {
        //     view: "button", name: "submit", value: "Reload",
        //     on: {
        //         "onItemClick": function () {
        //
        //         }
        //     }
        // }
    ];

    function showHideLog() {
        var logButton = document.getElementById("logButton");
        if (!$$("log").isVisible()) {
            logButton.value = "Hide Log";
            $$("log").show();
        } else {
            logButton.value = "Show Log";
            $$("log").hide();
        }
    }

    function showLog() {
        var logButton = document.getElementById("logButton");
        if (!$$("log").isVisible()) {
            logButton.value = "Hide Log";
            $$("log").show();
        }
    }

    webix.ui({
        view: "form",
        margin: 0,
        id: "my_form",
        css: "form",
        elements: form1
    });
    webix.ajax().get('localhost:8080/status', function (t, d) {
        //  console.log(d.json());
        var result = d.json()
        $$('dtable').parse(result.oppos);
        //  $$('ErrorAdvancesList').parse(d.json().oppos)
    })



    function showContextMenu(node) {
        webix.ui({
            view: "contextmenu",
            id: "menu",
            width: 200,
            data: [
                "Reload", "Delete", "Export to SF"
            ]
        });

        $$("menu").show(node, {pos: "right"});


        $$("dtable").$view.oncontextmenu = function () {
            return false
        };
    }

    function showAdvTableContextMenu(target) {
        webix.ui({
            view: "contextmenu",
            id: "advTableMenu",
            width: 200,
            data: [
                "Next Block", "Previous Block", "Ignore Block", "Delete Block", "Mark As Fixed"
            ]
        });

        $$("advTableMenu").show(target, {pos: "right"});


        $$("advTable").$view.oncontextmenu = function () {
            return false
        };
    }

    $$("advTable").attachEvent("onHeaderClick", function (id, e, target) {
        showAdvTableContextMenu(target)
    });

    function buttonCheck(obj, column) {
        var stage = obj.stages.find(function (item) {
            return item.name === column
        });
        // console.log(column, stage && stage.stageStatus, obj.stages)
        stage = stage && stage.stageStatus;
        if (stage && stage.statusStr === "CompletedStStatus") {
            return "<a href=\"#\" class=\"button button-circle button-action\">";
        }
        if (stage && stage.statusStr === "ErrorStStatus") {
            return "<a href=\"#\" class=\"button button-circle button-caution\">";
        }
        if (stage && stage.statusStr === "InProcessStStatus") {
            return "<a href=\"#\" class=\"button button-circle\">";
        }
        return ''
    }

    function showAdvancesPopup() {


        webix.ajax().get('adv.json', function (t, d) {
            $$('advTable').parse(d.json().blocks[blockNumber]);
        })

        function getAdvancesData (elem) {
            $$('advTable').clearAll();
            webix.ajax().get('adv.json', function (t, d) {

                $$('advTable').parse(d.json().blocks[elem]);
            })
        }

        webix.ui({
            view:"popup",
            position: "center",
            id:"advancespopup",
            body:{
                id: "advances",
                view: "toolbar",
                hidden: true,
                height: 250,
                elements: [
                    {
                        view: "datatable",
                        scroll: true,
                        width: 800,
                        id: "advTable",
                        resizeColumn: true,
                        columns: [
                            {id: "date", header: "Date"},
                            {id: "descr", header: "Description", fillspace: true},
                            {id: "amount", header: "Amount"},
                            {id: "tags", header: "Tags", width: 180}
                        ],
                        on: {
                            'onItemClick': function (id, e, node) {

                                var obj = this.getItem(id);

                                $$("AdvanceEditor").setValue(obj.descr)
                            }}
                    },
                    {
                        width: 400,
                        rows: [
                            {
                                cols: [
                                    {
                                        id: "next-block",
                                        view: "button",
                                        value: "Next Block",
                                        on: {
                                            "onItemClick": function () {
                                                getAdvancesData(blockNumber + 1)
                                                blockNumber += 1
                                            }
                                        }
                                    },
                                    {
                                        id: "ignore-block",
                                        view: "button",
                                        value: "Ignore Block",
                                        on: {
                                            "onItemClick": function () {
                                            }
                                        }
                                    }
                                ]
                            },
                            {
                                cols: [
                                    {
                                        id: "prev-block",
                                        view: "button",
                                        value: "Previous Block",
                                        on: {
                                            "onItemClick": function () {
                                                getAdvancesData(blockNumber - 1)
                                                blockNumber -= 1
                                            }
                                        }
                                    },
                                    {
                                        id: "remove-block",
                                        view: "button",
                                        value: "Remove Block",
                                        on: {
                                            "onItemClick": function () {
                                                removeBlock(blockNumber)
                                            }
                                        }
                                    }
                                ]
                            },
                            {
                                id: "AdvanceEditor",
                                view: "textarea",
                                placeholder: "Write down new MCI"
                            },
                            {
                                id: "dropDown",
                                view: "select",
                                options: [
                                    "Placeholder #1",
                                    "Placeholder #2",
                                    "Placeholder #1",
                                    "Placeholder #2",
                                    "Placeholder #1",
                                    "Placeholder #2",
                                    "Placeholder #1",
                                    "Placeholder #2",
                                    "Placeholder #1",
                                    "Placeholder #2",
                                    "Placeholder #3"
                                ]
                            },
                            {
                                id: "fixed-block",
                                view: "button",
                                value: "Mark As Fixed Block",
                                on: {
                                    "onItemClick": function () {
                                    }
                                }
                            }
                        ]
                    }
                    // {
                    //     id: "ErrorAdvancesList",
                    //     view: "list",
                    //     on: {
                    //         "onItemClick": function (id) {
                    //             var obj = this.getItem(id);
                    //             var stage = obj.stages.find(function (item) {
                    //                 return item.name === "Current advances checked"
                    //             });
                    //             $$("AdvanceEditor").setValue(stage.errors);
                    //         }
                    //     },
                    //     template: function (obj) {
                    //         var stage = obj.stages.find(function (item) {
                    //             return item.name === "Current advances checked"
                    //         });
                    //         return stage.errors
                    //     }
                    // },
                    // {
                    //     rows: [
                    //         {
                    //             cols: [
                    //                 {
                    //                     id: "AdvanceEditor",
                    //                     view: "textarea",
                    //                     placeholder: "Write down new MCI"
                    //                 },
                    //                 {
                    //                     id: "dropDown",
                    //                     view: "select",
                    //                     options: [
                    //                         "Placeholder #1",
                    //                         "Placeholder #2",
                    //                         "Placeholder #3"
                    //                     ],
                    //                     width: 120
                    //                 }
                    //             ]
                    //         },
                    //         {
                    //             id: "MCI button",
                    //             view: "button",
                    //             value: "Assign",
                    //             on: {
                    //                 "onItemClick": function () {
                    //                     webix.message("I don't know how to assign new MCI's")
                    //                 }
                    //             }
                    //         },
                    //         {
                    //             id: "Hide button",
                    //             view: "button",
                    //             value: "Done",
                    //             on: {
                    //                 "onItemClick": function () {
                    //                     $$("Current Advances").hide();
                    //                 }
                    //             }
                    //         }
                    //     ]
                    // }
                ]
            }
        }).show();
    }

    webix.ajax().get('adv.json', function (t, d) {
        $$('advTable').parse(d.json().blocks[blockNumber]);
    })

    function getAdvancesData (elem) {
        $$('advTable').clearAll();
        webix.ajax().get('adv.json', function (t, d) {

            $$('advTable').parse(d.json().blocks[elem]);
        })
    }

    function standartLog(stage) {
        switch (stage.statusStr) {
            case "CompletedStStatus":
                $$("log").setValue(stage.log);
                break;
            case "Error":
                $$("log").setValue(stage.log + "\n" + "\n" + "\n" + "Errors:\n" + stage.errors);
                break;
            case "In Process":
                $$("log").setValue(stage.log);
        }
        //$$("Current Advances").hide();
    }


</script>
</body>
</html>